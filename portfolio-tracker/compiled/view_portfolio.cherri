/*
 * Portfolio - View (with Live Prices)
 * Display portfolio with real-time stock prices
 */

#define name "Portfolio - View"
#define color green
#define glyph star

#include 'actions/web'
#include 'actions/scripting'
#include 'actions/text'

// Fetch AAPL price
const aaplURL = "https://query1.finance.yahoo.com/v8/finance/chart/AAPL"
const aaplData = downloadURL(aaplURL)
const aaplChart = getValue(aaplData, "chart")
const aaplResults = getValue(aaplChart, "result") 
const aaplFirst = getFirstItem(aaplResults)
const aaplMeta = getValue(aaplFirst, "meta")
const aaplPrice = getValue(aaplMeta, "regularMarketPrice")

// Fetch GOOGL price
const googlURL = "https://query1.finance.yahoo.com/v8/finance/chart/GOOGL"
const googlData = downloadURL(googlURL)
const googlChart = getValue(googlData, "chart")
const googlResults = getValue(googlChart, "result")
const googlFirst = getFirstItem(googlResults)
const googlMeta = getValue(googlFirst, "meta")
const googlPrice = getValue(googlMeta, "regularMarketPrice")

// Example portfolio calculations
const aaplShares = 100
const aaplCost = 150.25
@aaplCurrentValue = aaplShares * aaplPrice
@aaplCostTotal = aaplShares * aaplCost
@aaplGain = aaplCurrentValue - aaplCostTotal
@aaplGainPercent = (aaplGain / aaplCostTotal) * 100

const googlShares = 50
const googlCost = 135.00
@googlCurrentValue = googlShares * googlPrice
@googlCostTotal = googlShares * googlCost
@googlGain = googlCurrentValue - googlCostTotal
@googlGainPercent = (googlGain / googlCostTotal) * 100

// Portfolio totals
@totalValue = aaplCurrentValue + googlCurrentValue
@totalCost = aaplCostTotal + googlCostTotal
@totalGain = totalValue - totalCost
@totalGainPercent = (totalGain / totalCost) * 100

// Format numbers
@formattedAAPLValue = formatNumber(aaplCurrentValue, 2)
@formattedAAPLCost = formatNumber(aaplCostTotal, 2)
@formattedAAPLGain = formatNumber(aaplGain, 2)
@formattedAAPLGainPct = formatNumber(aaplGainPercent, 2)

@formattedGOOGLValue = formatNumber(googlCurrentValue, 2)
@formattedGOOGLCost = formatNumber(googlCostTotal, 2)
@formattedGOOGLGain = formatNumber(googlGain, 2)
@formattedGOOGLGainPct = formatNumber(googlGainPercent, 2)

@formattedTotalValue = formatNumber(totalValue, 2)
@formattedTotalCost = formatNumber(totalCost, 2)
@formattedTotalGain = formatNumber(totalGain, 2)
@formattedTotalGainPct = formatNumber(totalGainPercent, 2)

// Build summary
@summary = "ğŸ“Š PORTFOLIO SUMMARY (LIVE)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
AAPL: {aaplShares} shares
Current: ${aaplPrice} Ã— {aaplShares} = ${formattedAAPLValue}
Cost:    ${aaplCost} Ã— {aaplShares} = ${formattedAAPLCost}
Gain:    ${formattedAAPLGain} (+{formattedAAPLGainPct}%)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
GOOGL: {googlShares} shares
Current: ${googlPrice} Ã— {googlShares} = ${formattedGOOGLValue}
Cost:    ${googlCost} Ã— {googlShares} = ${formattedGOOGLCost}
Gain:    ${formattedGOOGLGain} (+{formattedGOOGLGainPct}%)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Total Value: ${formattedTotalValue}
Total Cost:  ${formattedTotalCost}
Gain/Loss:   ${formattedTotalGain} (+{formattedTotalGainPct}%)

âœ… Fetched REAL-TIME prices from Yahoo Finance!"

show(summary)
